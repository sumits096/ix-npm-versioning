# steps:
# - name: 'gcr.io/cloud-builders/gcloud'
#   id: 'decrypt npmrc'
#   args:
#   - kms
#   - decrypt
#   - --ciphertext-file=npmrc.enc
#   - --plaintext-file=/root/.npmrc
#   - --location=global
#   - --keyring=sdk-package-keyring
#   - --key=sdk-publish-key
#   volumes:
#     - name: 'home'
#       path: /root/

# - name: 'gcr.io/cloud-builders/npm'
#   id: 'install'
#   args: ['install']
#   env:
#   - HOME=/root/
#   volumes:
#   - name: 'home'
#     path: /root/

# - name: 'gcr.io/cloud-builders/npm'
#   id: 'test'
#   args: ['run', 'test']
# - name: 'gcr.io/cloud-builders/docker'
#   id: 'build'
#   args: [
#     'build',
#     '--build-arg',
#     'npmtoken=${_NPM_TOKEN}',
#     '-t',
#     'eu.gcr.io/$PROJECT_ID/$REPO_NAME:$SHORT_SHA',
#     '.']
# #- name: 'gcr.io/cloud-builders/gcloud'
#   #args: ['app', 'deploy']
# substitutions:
#     _NPM_TOKEN: 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
# images: ['eu.gcr.io/$PROJECT_ID/$REPO_NAME:$SHORT_SHA']



steps:
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - kms
  - decrypt
  - --ciphertext-file=npmrc.enc
  - --plaintext-file=/root/.npmrc
  - --location=global
  - --keyring=sdk-package-keyring
  - --key=sdk-publish-key
  volumes:
  - name: 'home'
    path: /root/

- name: 'gcr.io/cloud-builders/npm'
  args: ['install']

- name: 'gcr.io/cloud-builders/npm'
  args: ['testpackage']

- name: 'gcr.io/cloud-builders/npm'
  args: ['publish']
  env:
  - HOME=/root/
  volumes:
  - name: 'home'
    path: /root/
